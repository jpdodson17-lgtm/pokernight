<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Poker Tracker ‚Äì Roster, Games, Lifetime</title>

<!-- Supabase JS SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0b1020; --card:#0f1a2a; --muted:#8aa0b8; --text:#e9eef5;
    --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --line:#1f2a3a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#07121f,#0b1826);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  h1,h2,h3{margin:.2rem 0}
  .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
  .grid{display:grid;gap:16px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:rgba(15,26,42,.9);border:1px solid var(--line);border-radius:16px;padding:16px;backdrop-filter:saturate(120%) blur(4px);box-shadow:0 10px 30px rgba(0,0,0,.25)}
  input,button,select{font:inherit}
  input[type="text"],input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #203040;background:#0a1422;color:var(--text)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:9px 12px;border-radius:10px;border:1px solid #26364a;background:#0a1422;color:var(--text);cursor:pointer}
  .btn:hover{background:#0e1a2b}
  .btn.primary{border-color:#1a6b3b;background:#0d2016}
  .btn.red{border-color:#7a1f1f;background:#1a0f0f}
  .btn.ghost{background:transparent}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #2a3c52;color:var(--muted);font-size:12px;margin-right:6px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{text-align:left;padding:8px 10px}
  thead th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  tbody tr{background:#0a1422;border:1px solid #1b2a3a}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .good{color:var(--accent)}
  .bad{color:var(--danger)}
  .section-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin:0 0 6px 0}
  .stack{display:flex;flex-direction:column;gap:10px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .hidden{display:none}
  hr{border:0;border-top:1px solid var(--line);margin:10px 0}
  #status{position:fixed;bottom:10px;left:10px;background:#0a1422;color:#e9eef5;border:1px solid #203040;border-radius:8px;padding:6px 10px;font:12px/1.2 system-ui;z-index:9999}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
    <h1>üÉè Poker Tracker</h1>
    <div class="row">
      <button class="btn" id="newGameBtn">New Game</button>
      <button class="btn" id="refreshBtn">Refresh</button>
    </div>
  </div>

  <div class="grid">
    <!-- Left: Players Bank & Lifetime -->
    <div class="card">
      <h2>Players Bank</h2>
      <div class="row">
        <input id="newPlayerName" type="text" placeholder="Add new player name‚Ä¶" />
        <button class="btn primary" id="addPlayerBtn">Add Player</button>
      </div>
      <div class="stack" style="margin-top:10px">
        <div class="section-title">All Players</div>
        <table>
          <thead><tr><th>Player</th><th class="right">Actions</th></tr></thead>
          <tbody id="playersBankBody"></tbody>
        </table>
      </div>
      <hr/>
      <h2>Lifetime Leaderboard</h2>
      <div class="chips" id="lifetimeSummary"></div>
      <table style="margin-top:8px">
        <thead><tr><th>Player</th><th class="right">Lifetime Net</th></tr></thead>
        <tbody id="lifetimeBody"></tbody>
      </table>
    </div>

    <!-- Right: Game Controls -->
    <div class="card">
      <h2>Game Controls</h2>
      <div id="noGamePane">
        <div class="section-title">Create New Game</div>
        <div class="row">
          <input id="gameName" type="text" placeholder="Game name (e.g., Family Night 2025-08-29)" />
          <button class="btn primary" id="createGameBtn">Create & Select Players</button>
        </div>
        <hr/>
        <div class="section-title">Or Join Existing Game</div>
        <div class="row">
          <select id="existingGames" style="flex:1; padding:10px; border-radius:10px; background:#0a1422; color:#fff; border:1px solid #203040"></select>
          <button class="btn" id="joinGameBtn">Join</button>
        </div>
      </div>

      <div id="gamePane" class="hidden">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 id="currentGameTitle">Game</h3>
          <div class="row">
            <button class="btn" id="selectPlayersBtn">Select Players</button>
            <button class="btn red" id="endGameBtn">End Game</button>
            <button class="btn red" id="deleteGameBtn">Delete Game</button>
          </div>
        </div>

        <div id="selectPlayersPane" class="hidden card" style="margin:10px 0">
          <div class="section-title">Pick players for this game</div>
          <div id="playersCheckboxes" class="stack"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="applyPlayersBtn">Apply Selection</button>
            <button class="btn" id="cancelPlayersBtn">Cancel</button>
          </div>
        </div>

        <div class="section-title">Players in this Game</div>
        <table>
          <thead><tr><th>Player</th><th class="right">Buy-ins</th><th class="right">Cash-out</th><th class="right">Net</th><th class="right">Actions</th></tr></thead>
        <tbody id="gamePlayersBody"></tbody>
        </table>

        <div class="section-title" style="margin-top:10px">Settlement</div>
        <div id="settlements"></div>
      </div>
    </div>
  </div>
</div>

<div id="status">Checking Supabase‚Ä¶</div>

<script>
/*** CONFIG ‚Äî your Supabase project URL and anon key ***/
const SUPABASE_URL  = "https://agyveiqcxcxkporhipcy.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFneXZlaXFjeGN4a3BvcmhpcGN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODM3OTIsImV4cCI6MjA3MjA1OTc5Mn0.LUCAdM_f4L5oRHJYnjm6W34Tw23CzQ-nyfvTUk5hRWM";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/*** STATE ***/
let currentGame = null;

/*** HELPERS ***/
const $ = s => document.querySelector(s);
const fmt = n => (isNaN(n) ? '-' : '$' + Number(n).toFixed(2));

/*** STATUS CHECK ***/
(async () => {
  const status = $('#status');
  try {
    const { data, error } = await sb.from('players').select('id').limit(1);
    if (error) throw error;
    status.textContent = '‚úÖ Connected to Supabase';
  } catch (e) {
    status.textContent = '‚ùå Supabase error: ' + (e?.message || e);
    console.error(e);
  }
})();

/*** PLAYERS BANK ***/
async function fetchPlayers() {
  const { data, error } = await sb.from('players').select('*').order('name');
  if (error) { alert(error.message); return []; }
  return data || [];
}
async function addPlayer(name){
  name = (name || '').trim();
  if(!name) { alert('Enter a player name.'); return; }
  const { error } = await sb.from('players').insert({ name });
  if (error) { alert('Supabase insert error: ' + error.message); return; }
  $('#newPlayerName').value = '';
  await renderPlayersBank();
  await renderPlayersSelection();
  await renderLifetime();
}
async function deletePlayer(id){
  if(!confirm('Remove this player from bank?')) return;
  const { error } = await sb.from('players').delete().eq('id', id);
  if(error){ alert(error.message); return; }
  await renderPlayersBank();
  await renderPlayersSelection();
  await renderLifetime();
}
async function renderPlayersBank(){
  const players = await fetchPlayers();
  $('#playersBankBody').innerHTML = players.map(p=>`
    <tr>
      <td>${p.name}</td>
      <td class="right">
        <button class="btn red" onclick="deletePlayer('${p.id}')">Remove</button>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="2" class="muted">No players yet.</td></tr>`;
}

/*** GAMES ***/
async function fetchGames(){
  const { data, error } = await sb.from('games').select('*').order('created_at', { ascending:false });
  if(error){ alert(error.message); return []; }
  return data || [];
}
async function createGame(name){
  name = (name || '').trim();
  if(!name) name = 'Poker Night ' + new Date().toLocaleString();
  const { data, error } = await sb.from('games').insert({ name }).select().single();
  if(error){ alert(error.message); return; }
  currentGame = data;
  showGamePane();
  $('#currentGameTitle').textContent = `Game: ${currentGame.name}`;
  await renderPlayersSelection(true);
  $('#selectPlayersPane').classList.remove('hidden'); // open selection after creation
  await renderGame();
  await renderGamesDropdown();
}
async function renderGamesDropdown(){
  const games = await fetchGames();
  const sel = $('#existingGames');
  sel.innerHTML = games.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
}
async function joinGameById(id){
  const { data, error } = await sb.from('games').select('*').eq('id', id).single();
  if(error){ alert(error.message); return; }
  currentGame = data;
  showGamePane();
  $('#currentGameTitle').textContent = `Game: ${currentGame.name}`;
  await renderGame();
}

/*** UI PANE TOGGLES ***/
function showGamePane(){
  $('#noGamePane').classList.add('hidden');
  $('#gamePane').classList.remove('hidden');
}
function showNoGamePane(){
  $('#gamePane').classList.add('hidden');
  $('#noGamePane').classList.remove('hidden');
}

/*** GAME ROSTER SELECT ***/
async function fetchGamePlayers(game_id){
  const { data, error } = await sb.from('game_players')
    .select('player_id, players(name)')
    .eq('game_id', game_id).order('players(name)');
  if(error){ alert(error.message); return []; }
  return data || [];
}
async function renderPlayersSelection(open=false){
  if(!currentGame) return;
  const [bank, gp] = await Promise.all([fetchPlayers(), fetchGamePlayers(currentGame.id)]);
  const selected = new Set(gp.map(r=>r.player_id));
  $('#playersCheckboxes').innerHTML = bank.map(p=>`
    <label style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" value="${p.id}" ${selected.has(p.id)?'checked':''}/>
      <span>${p.name}</span>
    </label>
  `).join('') || `<div class="muted">No players in bank.</div>`;
  if(open) $('#selectPlayersPane').classList.remove('hidden');
}
async function applyPlayersSelection(){
  if(!currentGame) return;
  const checks = Array.from($('#playersCheckboxes').querySelectorAll('input[type=checkbox]'));
  const chosen = checks.filter(c=>c.checked).map(c=>c.value);
  const current = await fetchGamePlayers(currentGame.id);
  const have = new Set(current.map(r=>r.player_id));

  const toAdd = chosen.filter(id=>!have.has(id)).map(player_id=>({ game_id: currentGame.id, player_id }));
  if(toAdd.length){
    const { error } = await sb.from('game_players').insert(toAdd);
    if(error) alert(error.message);
  }
  const toRemove = current.filter(r=>!chosen.includes(r.player_id)).map(r=>r.player_id);
  if(toRemove.length){
    const { error } = await sb.from('game_players').delete().eq('game_id', currentGame.id).in('player_id', toRemove);
    if(error) alert(error.message);
  }
  $('#selectPlayersPane').classList.add('hidden');
  await renderGame();
}

/*** GAME ACTIONS (buy-ins, cash-outs) ***/
async function addBuyin(player_id, amount){
  amount = Number(amount);
  if(!(amount>0)) return alert('Enter a valid buy-in (> 0)');
  const { error } = await sb.from('buyins').insert({ game_id: currentGame.id, player_id, amount });
  if(error) alert(error.message);
}
async function setCashout(player_id){
  const inp = prompt('Final cash-out amount (>= 0):'); if(inp===null) return;
  const amount = Number(inp); if(!(amount>=0)) return alert('Enter a valid number (>= 0)');
  const { data, error } = await sb.from('cashouts').update({ amount }).eq('game_id', currentGame.id).eq('player_id', player_id).select();
  if(error) alert(error.message);
  if(!data || data.length===0){
    const { error: e2 } = await sb.from('cashouts').insert({ game_id: currentGame.id, player_id, amount });
    if(e2) alert(e2.message);
  }
}

/*** LOAD + RENDER CURRENT GAME ***/
async function loadGameState(game_id){
  const { data: gp, error: e1 } = await sb.from('game_players')
    .select('player_id, players(name)').eq('game_id', game_id);
  if(e1){ alert(e1.message); return []; }
  const ids = gp.map(r=>r.player_id);
  if(ids.length === 0) return [];
  const { data: bi, error: e2 } = await sb.from('buyins').select('*').eq('game_id', game_id).in('player_id', ids);
  if(e2){ alert(e2.message); return []; }
  const { data: co, error: e3 } = await sb.from('cashouts').select('*').eq('game_id', game_id).in('player_id', ids);
  if(e3){ alert(e3.message); return []; }

  const byPlayer = {};
  for(const r of gp){ byPlayer[r.player_id] = { id:r.player_id, name:r.players.name, buyins:0, cashout:0, net:0 }; }
  for(const b of bi){ byPlayer[b.player_id].buyins += Number(b.amount); }
  for(const c of co){ byPlayer[c.player_id].cashout = Number(c.amount); }
  for(const k in byPlayer){ const p = byPlayer[k]; p.net = p.cashout - p.buyins; }
  return Object.values(byPlayer).sort((a,b)=> a.name.localeCompare(b.name));
}
async function renderGame(){
  if(!currentGame){ showNoGamePane(); return; }
  $('#currentGameTitle').textContent = `Game: ${currentGame.name}`;
  const rows = await loadGameState(currentGame.id);
  const tbody = $('#gamePlayersBody');
  tbody.innerHTML = rows.map(p=>`
    <tr>
      <td>${p.name}</td>
      <td class="right">${fmt(p.buyins)}</td>
      <td class="right">${fmt(p.cashout)}</td>
      <td class="right"><b class="${p.net>0?'good':(p.net<0?'bad':'')}">${fmt(p.net)}</b></td>
      <td class="right">
        <button class="btn" onclick="quickBuyin('${p.id}')">+ Buy-in</button>
        <button class="btn" onclick="setCashout('${p.id}')">Set Cash-out</button>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="5" class="muted">No players selected yet. Click ‚ÄúSelect Players‚Äù.</td></tr>`;

  const txns = computeSettlements(rows);
  $('#settlements').innerHTML = txns.length ? txns.map(t=>`
    <div class="pill" style="display:flex;justify-content:space-between;gap:10px;min-width:240px">
      <span>üí∏ <b>${t.from}</b> ‚Üí <b>${t.to}</b></span>
      <span><b>${fmt(t.amount)}</b></span>
    </div>
  `).join('') : `<div class="muted">Enter cash-outs to compute who owes whom.</div>`;
}
function computeSettlements(nets){
  const creditors = nets.filter(x=>x.net>0).map(x=>({...x}));
  const debtors = nets.filter(x=>x.net<0).map(x=>({...x}));
  creditors.sort((a,b)=>b.net-a.net); debtors.sort((a,b)=>a.net-b.net);
  const txns=[]; let i=0,j=0;
  while(i<debtors.length && j<creditors.length){
    const owe = Math.min(creditors[j].net, -debtors[i].net);
    if(owe>0.0001){
      txns.push({from: debtors[i].name, to: creditors[j].name, amount: owe});
      creditors[j].net -= owe; debtors[i].net += owe;
    }
    if(creditors[j].net<=0.0001) j++;
    if(debtors[i].net>=-0.0001) i++;
  }
  return txns;
}

/*** LIFETIME LEADERBOARD ***/
async function renderLifetime(){
  const players = await fetchPlayers();
  if(players.length===0){ $('#lifetimeBody').innerHTML = `<tr><td colspan="2" class="muted">No players yet.</td></tr>`; return; }

  const { data: bi, error: e1 } = await sb.from('buyins').select('player_id, amount');
  const { data: co, error: e2 } = await sb.from('cashouts').select('player_id, amount');
  if(e1||e2){ alert((e1||e2).message); return; }

  const buy = {}; const cash = {};
  (bi||[]).forEach(r => buy[r.player_id] = (buy[r.player_id]||0) + Number(r.amount));
  (co||[]).forEach(r => cash[r.player_id] = (cash[r.player_id]||0) + Number(r.amount));

  const rows = players.map(p=>{
    const net = (cash[p.id]||0) - (buy[p.id]||0);
    return { id:p.id, name:p.name, net };
  }).sort((a,b)=> b.net - a.net);

  $('#lifetimeSummary').innerHTML = `
    <span class="pill">Players: <b>${players.length}</b></span>
    <span class="pill">All-time Leader: <b>${rows[0]?rows[0].name:'‚Äî'}</b></span>
  `;
  $('#lifetimeBody').innerHTML = rows.map(r=>`
    <tr>
      <td>${r.name}</td>
      <td class="right"><b class="${r.net>0?'good':(r.net<0?'bad':'')}">${fmt(r.net)}</b></td>
    </tr>
  `).join('');
}

/*** END / DELETE GAME ***/
async function endGame(){
  if(!currentGame) return;
  const rows = await loadGameState(currentGame.id);
  if(!rows.length){ alert('No players in this game.'); return; }
  const sorted = [...rows].sort((a,b)=> b.net - a.net);
  const winner = sorted[0], loser = sorted[sorted.length-1];
  alert(`Winner: ${winner.name} (+${fmt(winner.net)})\nLoser: ${loser.name} (${fmt(loser.net)})`);
}
async function deleteGame(id) {
  if (!id) return;
  if (!confirm("Delete this game and all related buy-ins/cash-outs?")) return;
  const { error } = await sb.from('games').delete().eq('id', id);
  if (error) { alert("Error deleting game: " + error.message); return; }
  currentGame = null;
  showNoGamePane();
  await renderGamesDropdown();
}

/*** QUICK BUY-IN PROMPT (global for inline handlers) ***/
window.quickBuyin = async function(player_id){
  const amt = prompt('Buy-in amount (> 0):'); if(amt===null) return;
  await addBuyin(player_id, Number(amt));
};

/*** EVENTS ***/
$('#addPlayerBtn').addEventListener('click', ()=> addPlayer($('#newPlayerName').value));
$('#createGameBtn').addEventListener('click', ()=> createGame($('#gameName').value));
$('#joinGameBtn').addEventListener('click', ()=> {
  const id = $('#existingGames').value; if(!id) return alert('Pick a game from the list.');
  joinGameById(id);
});
$('#selectPlayersBtn').addEventListener('click', async ()=>{
  await renderPlayersSelection(true);
  $('#selectPlayersPane').classList.remove('hidden');
});
$('#applyPlayersBtn').addEventListener('click', applyPlayersSelection);
$('#cancelPlayersBtn').addEventListener('click', ()=> $('#selectPlayersPane').classList.add('hidden'));
$('#endGameBtn').addEventListener('click', endGame);
$('#deleteGameBtn').addEventListener('click', ()=> deleteGame(currentGame?.id));
$('#newGameBtn').addEventListener('click', ()=>{
  currentGame = null;
  showNoGamePane();
});
$('#refreshBtn').addEventListener('click', async ()=>{
  await Promise.all([renderPlayersBank(), renderGamesDropdown(), renderLifetime()]);
  if(currentGame) await renderGame();
});

/*** REALTIME SUBSCRIPTIONS ***/
sb.channel('realtime:players')
 .on('postgres_changes', { event:'*', schema:'public', table:'players' }, async ()=>{
   await renderPlayersBank(); await renderPlayersSelection(); await renderLifetime();
 }).subscribe();

sb.channel('realtime:games')
 .on('postgres_changes', { event:'*', schema:'public', table:'games' }, async ()=>{
   await renderGamesDropdown();
 }).subscribe();

['game_players','buyins','cashouts'].forEach(t=>{
  sb.channel('realtime:'+t)
    .on('postgres_changes', { event:'*', schema:'public', table:t }, async ()=>{
      if(currentGame) await renderGame();
      await renderLifetime();
    })
    .subscribe();
});

/*** INITIAL RENDER ***/
(async function init(){
  await Promise.all([renderPlayersBank(), renderGamesDropdown(), renderLifetime()]);
  // If there are no games at all, keep noGamePane visible.
  showNoGamePane();
})();
</script>
</body>
</html>
