<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Poker Tracker ‚Äì vNEXT + Fun Tools</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0b1020; --card:#0f1a2a; --muted:#8aa0b8; --text:#e9eef5;
    --accent:#22c55e; --danger:#ef4444; --line:#1f2a3a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#07121f,#0b1826);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
  .grid{display:grid;gap:16px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:#0f1a2a;border:1px solid #1f2a3a;border-radius:16px;padding:16px}
  input,button,select{font:inherit}
  input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #203040;background:#0a1422;color:var(--text)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{padding:9px 12px;border-radius:10px;border:1px solid #26364a;background:#0a1422;color:var(--text);cursor:pointer}
  .btn:hover{background:#0e1a2b}
  .btn.primary{border-color:#1a6b3b;background:#0d2016}
  .btn.ghost{background:transparent;border-color:#26364a}
  .btn.red{border-color:#7a1f1f;background:#1a0f0f}
  .hidden{display:none !important}

  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:12px;color:#8aa0b8;text-transform:uppercase;letter-spacing:.08em;text-align:left}
  td{padding:8px 10px} th{padding:4px 10px}
  tbody tr{background:#0a1422;border:1px solid #1b2a3a}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .right{text-align:right}

  /* Collapsible Players Bank */
  .collapsible{display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:8px 12px;border:1px solid #1f2a3a;border-radius:10px;background:#0a1422}
  .collapsible .title{display:flex;align-items:center;gap:8px}
  .chev{transition:transform .2s ease}
  .collapsed .chev{transform:rotate(-90deg)}

  /* Debug pill/panel */
  #debugWrap{position:fixed;left:12px;bottom:12px;z-index:9999}
  #debugPill{background:#0a1422;border:1px solid #333;color:#e9eef5;border-radius:999px;padding:6px 10px;font:12px/1 ui-monospace;cursor:pointer;opacity:.9}
  #debugPanel{display:none;max-width:420px;background:#0a0a0a;color:#e9eef5;border:1px solid #333;border-radius:10px;padding:8px 10px;font:12px/1.4 ui-monospace,Menlo;white-space:pre-wrap;opacity:.95;margin-top:6px}
  #debugPanel .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
  #debugPanel .close{cursor:pointer;border:1px solid #444;border-radius:6px;padding:1px 6px}
  #debugPanel b{color:#22c55e} #debugPanel .err{color:#ef4444}

  /* ---------- MODALS ---------- */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9998}
  .modal.open{display:flex}
  .modal .sheet{position:relative;background:#0f1a2a;border:1px solid #203040;border-radius:18px;box-shadow:0 20px 80px rgba(0,0,0,.5);padding:16px;max-width:920px;width:95%}
  .modal .sheet h3{margin:0 0 10px}
  .modal .closeX{position:absolute;right:10px;top:10px;cursor:pointer;border:1px solid #2a3a4f;border-radius:8px;padding:3px 8px;background:#0a1422}
  .modal .toolbar{display:flex;gap:8px;align-items:center;margin:8px 0 12px}
  .modal .tray{display:grid;gap:14px}

  /* ---------- WHEEL styles ---------- */
  .wheel-wrap{position:relative;display:grid;place-items:center}
  .wheel-pointer{
    position:absolute; left:50%; top:-6px; transform:translateX(-50%);
    width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-top:30px solid #f8fafc;
    filter:drop-shadow(0 2px 3px rgba(0,0,0,.5));
  }
  #wheelCanvas{background:#0f172a;border-radius:16px;border:1px solid #223049;display:block;width:min(560px,85vw);height:auto}

  /* ---------- 8-BALL styles ---------- */
  .ball-wrap{position:relative; width:min(520px, 85vw); aspect-ratio:1/1; display:grid; place-items:center; margin:0 auto}
  .ground-shadow{position:absolute; inset:auto 0 -12px 0; margin:auto; width:70%; height:22px; border-radius:50%;
    background: radial-gradient(closest-side, rgba(0,0,0,.42), rgba(0,0,0,0)); filter: blur(6px); pointer-events:none;}
  .ball{
    position:relative; width:100%; height:100%; border-radius:50%;
    background:
      radial-gradient(60% 55% at 38% 30%, rgba(255,255,255,.09), transparent 60%),
      radial-gradient(42% 38% at 62% 66%, rgba(255,255,255,.06), transparent 70%),
      radial-gradient(90% 90% at 50% 45%, #1a1a1a, #0b0b0b 55%, #020202);
    box-shadow:
      inset 0 24px 110px rgba(255,255,255,.08),
      inset 0 -40px 120px rgba(0,0,0,.85),
      0 40px 160px rgba(0,0,0,.55);
    overflow:hidden;
  }
  .grain{position:absolute; inset:0; opacity:.08; pointer-events:none; mix-blend-mode:soft-light;
    background-image:
      radial-gradient(1px 1px at 13% 23%, #fff 40%, transparent 41%),
      radial-gradient(1px 1px at 73% 63%, #fff 40%, transparent 41%),
      radial-gradient(1px 1px at 41% 79%, #fff 40%, transparent 41%),
      radial-gradient(1px 1px at 83% 37%, #fff 40%, transparent 41%);
    background-size: 140px 140px, 160px 160px, 180px 180px, 200px 200px;
  }
  .window{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:44%; aspect-ratio:1; border-radius:50%;
    background:
      radial-gradient(52% 44% at 46% 36%, rgba(255,255,255,.15), rgba(255,255,255,0) 60%),
      radial-gradient(62% 60% at 52% 58%, #132a45, #0b1726);
    border:2px solid rgba(200,220,255,.28);
    box-shadow: inset 0 12px 36px rgba(255,255,255,.25), inset 0 -20px 46px rgba(0,0,0,.6), 0 0 0 5px rgba(0,0,0,.55), 0 0 0 9px #0b0e18;
    display:grid; place-items:center; overflow:hidden;
  }
  .shine{position:absolute; inset:0; pointer-events:none; border-radius:50%;
    background: radial-gradient(34% 20% at 36% 28%, rgba(255,255,255,.18), transparent 60%), radial-gradient(25% 18% at 62% 64%, rgba(255,255,255,.1), transparent 70%);
    mix-blend-mode:screen;}
  .triangle{ position:relative; width:76%; aspect-ratio:1; transform: translateY(8%) scale(.98); }
  .tri-shape{
    width:100%; height:100%;
    background: conic-gradient(from 180deg at 50% 63%, #0e5fda 0 120deg, #0b4fba 120deg 240deg, #093f96 240deg 360deg);
    -webkit-clip-path: polygon(50% 0%, 0% 86%, 100% 86%);
            clip-path: polygon(50% 0%, 0% 86%, 100% 86%);
    border:1px solid rgba(255,255,255,.18);
    filter: drop-shadow(0 8px 12px rgba(0,0,0,.5));
  }
  .answer{position:absolute; left:50%; top:52%; transform:translate(-50%,-50%); width:70%; text-align:center; color:#eaf2ff; font-weight:850; letter-spacing:.02em; text-shadow: 0 2px 4px rgba(0,0,0,.6); font-size: clamp(13px, 2.8vw, 20px); }
  .shake{ animation: shake 2.8s cubic-bezier(.36,.07,.19,.97) both; }
  @keyframes shake{
    0% { transform: translateZ(0) }
    6% { transform: translate(8px,-6px) rotate(-2deg) }
    14%{ transform: translate(-10px,7px) rotate(2.6deg) }
    22%{ transform: translate(10px,-8px) rotate(-3.1deg) }
    30%{ transform: translate(-9px,6px) rotate(2.2deg) }
    38%{ transform: translate(7px,-5px) rotate(-1.6deg) }
    46%{ transform: translate(-6px,4px) rotate(1.2deg) }
    56%{ transform: translate(5px,-3px) rotate(-.9deg) }
    66%{ transform: translate(-4px,2px) rotate(.6deg) }
    76%{ transform: translate(3px,-2px) rotate(-.4deg) }
    86%{ transform: translate(-2px,1px) rotate(.25deg) }
    100%{ transform: translate(0,0) rotate(0) }
  }
  .reveal{ animation: reveal 700ms ease-out both 1.7s; }
  @keyframes reveal{
    0% { opacity:0; transform:translate(-50%,-44%) scale(.92); filter:blur(2px) }
    100%{ opacity:1; transform:translate(-50%,-50%) scale(1); filter:blur(0) }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
    <div>
      <h1 style="margin:0">üÉè Poker Tracker</h1>
      <div id="version" style="color:#8aa0b8;font-size:12px;margin-left:2px">Build: 007</div>
    </div>
    <div class="row">
      <!-- NEW FUN BUTTONS -->
      <button class="btn ghost" id="openWheel">üé° Fun Wheel</button>
      <button class="btn ghost" id="openBall">üé± Magic 8-Ball</button>
      <button class="btn" id="newGameBtn">New Game</button>
      <button class="btn" id="refreshBtn">Refresh</button>
    </div>
  </div>

  <div class="grid">
    <!-- Left: Players + Lifetime -->
    <div class="card">
      <!-- Collapsible Players Bank -->
      <div id="bankHeader" class="collapsible collapsed" title="Click to expand/collapse">
        <div class="title"><span class="chev">‚ñæ</span><b>Players Bank</b></div>
        <div id="bankCount" style="color:#8aa0b8;font-size:12px"></div>
      </div>
      <div id="bankBody" class="hidden" style="margin-top:10px">
        <div class="row">
          <input id="newPlayerName" type="text" placeholder="Add new player name‚Ä¶" />
          <button class="btn primary" id="addPlayerBtn">Add Player</button>
        </div>
        <div style="margin-top:10px">
          <table>
            <thead><tr><th>Player</th><th class="right">Actions</th></tr></thead>
            <tbody id="playersBankBody"></tbody>
          </table>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid #1f2a3a;margin:12px 0"/>

      <h2>Lifetime Leaderboard</h2>
      <table>
        <thead><tr><th>Player</th><th class="right">Lifetime Net</th></tr></thead>
        <tbody id="lifetimeBody"></tbody>
      </table>
    </div>

    <!-- Right: Game Controls -->
    <div class="card">
      <h2>Game Controls</h2>
      <div id="noGamePane">
        <div class="row">
          <input id="gameName" type="text" placeholder="Game name (e.g., Family Night)" />
          <button class="btn primary" id="createGameBtn">Create & Select Players</button>
        </div>
        <div class="row" style="margin-top:10px">
          <select id="existingGames" style="flex:1; padding:10px; border-radius:10px; background:#0a1422; color:#e9eef5; border:1px solid #203040"></select>
          <button class="btn" id="joinGameBtn">Join</button>
        </div>
      </div>

      <div id="gamePane" class="hidden">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 id="currentGameTitle">Game</h3>
          <div class="row">
            <button class="btn" id="selectPlayersBtn">Select Players</button>
            <button class="btn" id="endGameBtn">End Game</button>
            <button class="btn" id="deleteGameBtn">Delete Game</button>
          </div>
        </div>

        <div id="selectPlayersPane" class="hidden card" style="margin:10px 0">
          <div>Pick players for this game</div>
          <div id="playersCheckboxes" style="display:flex;flex-direction:column;gap:8px;margin-top:8px"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="applyPlayersBtn">Apply Selection</button>
            <button class="btn" id="cancelPlayersBtn">Cancel</button>
          </div>
        </div>

        <div style="margin-top:8px">Players in this Game</div>
        <table>
          <thead><tr><th>Player</th><th class="right">Buy-ins</th><th class="right">Cash-out</th><th class="right">Net</th><th class="right">Actions</th></tr></thead>
        <tbody id="gamePlayersBody"></tbody>
        </table>

        <div style="margin-top:8px">Settlement</div>
        <div id="settlements"></div>
      </div>
    </div>
  </div>
</div>

<!-- Debug pill/panel -->
<div id="debugWrap">
  <div id="debugPill">Debug ‚Ä¢ Connected</div>
  <div id="debugPanel">
    <div class="hdr">
      <div><b>Debug Log</b></div>
      <div class="close" id="debugClose">√ó</div>
    </div>
    <div id="debugBody">booting‚Ä¶</div>
  </div>
</div>

<!-- ====================== MODAL: FUN WHEEL ====================== -->
<div id="wheelModal" class="modal" aria-hidden="true">
  <div class="sheet">
    <button class="closeX" id="closeWheel">Close</button>
    <h3>üé° Fun Wheel</h3>
    <div class="toolbar">
      <button class="btn primary" id="spinBtn">‚ñ∂Ô∏è Spin</button>
      <button class="btn red" id="stopBtn">‚èπ Stop</button>
      <div id="wheelResult" style="margin-left:auto;color:#8aa0b8">‚Äî</div>
    </div>
    <div class="wheel-wrap">
      <div class="wheel-pointer"></div>
      <canvas id="wheelCanvas" width="560" height="560"></canvas>
    </div>
  </div>
</div>

<!-- ====================== MODAL: MAGIC 8-BALL ====================== -->
<div id="ballModal" class="modal" aria-hidden="true">
  <div class="sheet">
    <button class="closeX" id="closeBall">Close</button>
    <h3>üé± Magic 8-Ball</h3>
    <div style="color:#8aa0b8;margin:4px 0 10px;text-align:center">
      Question: <b>Is Yaya bluffing?</b>
    </div>
    <div class="tray">
      <div class="ball-wrap">
        <div class="ground-shadow"></div>
        <div id="ball" class="ball" role="button" aria-label="Magic 8-Ball (click to shake)">
          <div class="window">
            <div class="triangle">
              <div class="tri-shape"></div>
              <div id="answer" class="answer">‚Äî</div>
            </div>
            <div class="shine"></div>
          </div>
          <div class="grain"></div>
        </div>
      </div>
      <div class="toolbar" style="justify-content:center">
        <button id="shakeBtn" class="btn">Shake</button>
        <button id="againBtn" class="btn">Ask Again</button>
      </div>
    </div>
  </div>
</div>

<script>
/*** CONFIG: Supabase credentials ***/
const SUPABASE_URL  = "https://agyveiqcxcxkporhipcy.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFneXZlaXFjeGN4a3BvcmhpcGN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODM3OTIsImV4cCI6MjA3MjA1OTc5Mn0.LUCAdM_f4L5oRHJYnjm6W34Tw23CzQ-nyfvTUk5hRWM";

/*** DEBUG ***/
const dbgAppend = (msg, isErr=false) => {
  const body = document.getElementById('debugBody');
  const line = document.createElement('div');
  line.className = isErr ? 'err' : '';
  line.textContent = (isErr ? '‚úñ ' : '‚Ä¢ ') + msg;
  body.appendChild(line);
  console[isErr ? 'error' : 'log'](msg);
};
(function debugToggleInit(){
  const pill = document.getElementById('debugPill');
  const panel = document.getElementById('debugPanel');
  const close = document.getElementById('debugClose');
  pill.addEventListener('click', ()=> {
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
  });
  close.addEventListener('click', ()=> {
    panel.style.display = 'none';
    pill.style.display = 'none';
  });
})();

/*** SUPABASE INIT ***/
let sb;
try {
  if (!window.supabase) throw new Error("Supabase SDK failed to load.");
  sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  dbgAppend("Supabase client created.");
} catch (e) { dbgAppend(e.message || e, true); }

/*** STATE & HELPERS (app) ***/
let currentGame = null;
const $ = s => document.querySelector(s);
const fmt = n => (isNaN(n) ? '-' : '$' + Number(n).toFixed(2));

/*** SAFE WRAPPER ***/
const safe = fn => async (...args) => { try { return await fn(...args); } catch(e){ dbgAppend(String(e), true); alert(String(e)); } };

/*** DB CALLS ***/
const fetchPlayers = safe(async () => {
  const { data, error } = await sb.from('players').select('*').order('name');
  if (error) throw error;
  return data || [];
});
const addPlayer = safe(async (name) => {
  name = (name || '').trim();
  if(!name) { alert('Enter a player name.'); return; }
  const { error } = await sb.from('players').insert({ name });
  if (error) throw error;
  $('#newPlayerName').value = '';
  await renderPlayersBank(); await renderPlayersSelection(); await renderLifetime();
  dbgAppend(`Added player: ${name}`);
});
const deletePlayerDB = safe(async (id) => {
  const { error } = await sb.from('players').delete().eq('id', id);
  if (error) throw error;
});

const fetchGames = safe(async () => {
  const { data, error } = await sb.from('games').select('*').order('created_at', { ascending:false });
  if (error) throw error;
  return data || [];
});
const createGameDB = safe(async (name) => {
  const { data, error } = await sb.from('games').insert({ name }).select().single();
  if (error) throw error;
  return data;
});
const getGameById = safe(async (id) => {
  const { data, error } = await sb.from('games').select('*').eq('id', id).single();
  if (error) throw error;
  return data;
});

const fetchGamePlayers = safe(async (game_id) => {
  const { data, error } = await sb.from('game_players')
     .select('player_id, players(name)')
     .eq('game_id', game_id).order('players(name)');
  if (error) throw error;
  return data || [];
});
const insertGamePlayers = safe(async (rows) => {
  if (!rows.length) return;
  const { error } = await sb.from('game_players').insert(rows);
  if (error) throw error;
});
const deleteGamePlayers = safe(async (game_id, ids) => {
  if (!ids.length) return;
  const { error } = await sb.from('game_players').delete().eq('game_id', game_id).in('player_id', ids);
  if (error) throw error;
});

const insertBuyin = safe(async (game_id, player_id, amount) => {
  const { error } = await sb.from('buyins').insert({ game_id, player_id, amount });
  if (error) throw error;
});
const updateOrInsertCashout = safe(async (game_id, player_id, amount) => {
  const { data, error } = await sb.from('cashouts').update({ amount }).eq('game_id', game_id).eq('player_id', player_id).select();
  if (error) throw error;
  if (!data || data.length === 0) {
    const { error: e2 } = await sb.from('cashouts').insert({ game_id, player_id, amount });
    if (e2) throw e2;
  }
});

const loadGameState = safe(async (game_id) => {
  const gp = await fetchGamePlayers(game_id);
  const ids = gp.map(r=>r.player_id);
  if (ids.length === 0) return [];
  const { data: bi, error: e2 } = await sb.from('buyins').select('*').eq('game_id', game_id).in('player_id', ids);
  if (e2) throw e2;
  const { data: co, error: e3 } = await sb.from('cashouts').select('*').eq('game_id', game_id).in('player_id', ids);
  if (e3) throw e3;

  const byPlayer = {};
  for(const r of gp){ byPlayer[r.player_id] = { id:r.player_id, name:r.players.name, buyins:0, cashout:0, net:0 }; }
  for(const b of (bi||[])){ byPlayer[b.player_id].buyins += Number(b.amount); }
  for(const c of (co||[])){ byPlayer[c.player_id].cashout = Number(c.amount); }
  for(const k in byPlayer){ const p = byPlayer[k]; p.net = p.cashout - p.buyins; }
  return Object.values(byPlayer).sort((a,b)=> a.name.localeCompare(b.name));
});
const deleteGameDB = safe(async (id) => {
  const { error } = await sb.from('games').delete().eq('id', id);
  if (error) throw error;
});

/*** RENDERERS ***/
const renderPlayersBank = safe(async ()=>{
  const players = await fetchPlayers();
  $('#bankCount').textContent = players.length ? `${players.length} players` : 'none yet';
  $('#playersBankBody').innerHTML = players.map(p=>`
    <tr>
      <td>${p.name}</td>
      <td class="right"><button class="btn" data-del="${p.id}">Remove</button></td>
    </tr>
  `).join('') || `<tr><td colspan="2" style="color:#8aa0b8">No players yet.</td></tr>`;
  $('#playersBankBody').querySelectorAll('button[data-del]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!confirm('Remove this player from bank?')) return;
      await deletePlayerDB(btn.dataset.del);
      await renderPlayersBank();
      await renderPlayersSelection();
      await renderLifetime();
      dbgAppend('Deleted player '+btn.dataset.del);
    });
  });
});
const renderGamesDropdown = safe(async ()=>{
  const games = await fetchGames();
  $('#existingGames').innerHTML = games.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
});
const renderPlayersSelection = safe(async (open=false)=>{
  if(!currentGame) return;
  const [bank, gp] = await Promise.all([fetchPlayers(), fetchGamePlayers(currentGame.id)]);
  const selected = new Set(gp.map(r=>r.player_id));
  $('#playersCheckboxes').innerHTML = bank.map(p=>`
    <label style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" value="${p.id}" ${selected.has(p.id)?'checked':''}/>
      <span>${p.name}</span>
    </label>
  `).join('') || `<div style="color:#8aa0b8">No players in bank.</div>`;
  if(open) $('#selectPlayersPane').classList.remove('hidden');
});
function computeSettlements(nets){
  const creditors = nets.filter(x=>x.net>0).map(x=>({...x})).sort((a,b)=>b.net-a.net);
  const debtors   = nets.filter(x=>x.net<0).map(x=>({...x})).sort((a,b)=>a.net-b.net);
  const txns=[]; let i=0,j=0;
  while(i<debtors.length && j<creditors.length){
    const owe = Math.min(creditors[j].net, -debtors[i].net);
    if(owe>0.0001){ txns.push({from: debtors[i].name, to: creditors[j].name, amount: owe});
      creditors[j].net -= owe; debtors[i].net += owe; }
    if(creditors[j].net<=0.0001) j++;
    if(debtors[i].net>=-0.0001) i++;
  }
  return txns;
}
const renderGame = safe(async ()=>{
  if(!currentGame){
    $('#gamePane').classList.add('hidden');
    $('#noGamePane').classList.remove('hidden');
    return;
  }
  $('#noGamePane').classList.add('hidden');
  $('#gamePane').classList.remove('hidden');
  $('#currentGameTitle').textContent = `Game: ${currentGame.name}`;

  const rows = await loadGameState(currentGame.id);
  $('#gamePlayersBody').innerHTML = rows.map(p=>`
    <tr>
      <td>${p.name}</td>
      <td class="right">${fmt(p.buyins)}</td>
      <td class="right">${fmt(p.cashout)}</td>
      <td class="right"><b style="color:${p.net>0?'#22c55e':(p.net<0?'#ef4444':'#e9eef5')}">${fmt(p.net)}</b></td>
      <td class="right">
        <button class="btn" data-buyin="${p.id}">+ Buy-in</button>
        <button class="btn" data-cashout="${p.id}">Set Cash-out</button>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="5" style="color:#8aa0b8">No players selected yet. Click ‚ÄúSelect Players‚Äù.</td></tr>`;

  $('#gamePlayersBody').querySelectorAll('button[data-buyin]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const amt = prompt('Buy-in amount (> 0):'); if(amt===null) return;
      const n = Number(amt); if(!(n>0)) return alert('Enter a valid buy-in (> 0)');
      await insertBuyin(currentGame.id, btn.dataset.buyin, n);
      dbgAppend(`+ Buy-in ${n} for player ${btn.dataset.buyin}`);
      await renderGame(); await renderLifetime();
    });
  });
  $('#gamePlayersBody').querySelectorAll('button[data-cashout]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const amt = prompt('Final cash-out amount (>= 0):'); if(amt===null) return;
      const n = Number(amt); if(!(n>=0)) return alert('Enter a valid number (>= 0)');
      await updateOrInsertCashout(currentGame.id, btn.dataset.cashout, n);
      dbgAppend(`Set cash-out ${n} for player ${btn.dataset.cashout}`);
      await renderGame(); await renderLifetime();
    });
  });

  const txns = computeSettlements(rows);
  $('#settlements').innerHTML = txns.length
    ? txns.map(t=>`<div style="margin:4px 0">üí∏ <b>${t.from}</b> ‚Üí <b>${t.to}</b> <span style="float:right">${fmt(t.amount)}</span></div>`).join('')
    : `<div style="color:#8aa0b8">Enter cash-outs to compute who owes whom.</div>`;
});
const renderLifetime = safe(async ()=>{
  const players = await fetchPlayers();
  if(players.length===0){
    $('#lifetimeBody').innerHTML = `<tr><td colspan="2" style="color:#8aa0b8">No players yet.</td></tr>`; return;
  }
  const { data: bi, error: e1 } = await sb.from('buyins').select('player_id, amount'); if(e1) throw e1;
  const { data: co, error: e2 } = await sb.from('cashouts').select('player_id, amount'); if(e2) throw e2;
  const buy = {}, cash = {};
  (bi||[]).forEach(r => buy[r.player_id]  = (buy[r.player_id] || 0) + Number(r.amount));
  (co||[]).forEach(r => cash[r.player_id] = (cash[r.player_id]|| 0) + Number(r.amount));
  const rows = players.map(p => ({ name:p.name, net:(cash[p.id]||0) - (buy[p.id]||0) }))
                     .sort((a,b)=> b.net - a.net);
  $('#lifetimeBody').innerHTML = rows.map(r=>`
    <tr><td>${r.name}</td><td class="right"><b style="color:${r.net>0?'#22c55e':(r.net<0?'#ef4444':'#e9eef5')}">${fmt(r.net)}</b></td></tr>
  `).join('');
});

/*** ACTIONS ***/
const deleteGame = safe(async (id) => {
  if (!id) return;
  if (!confirm("Delete this game and all related buy-ins/cash-outs?")) return;
  await deleteGameDB(id);
  currentGame = null;
  await Promise.all([renderGamesDropdown(), renderPlayersBank(), renderLifetime()]);
  await renderGame();
  dbgAppend('Deleted game '+id);
});
const endGame = safe(async ()=>{
  if(!currentGame) return;
  const rows = await loadGameState(currentGame.id);
  if(!rows.length){ alert('No players in this game.'); return; }
  const sorted = [...rows].sort((a,b)=> b.net - a.net);
  const w = sorted[0], l = sorted[sorted.length-1];
  const winMsgs = ["rakes in the chips!","is buying pizza tonight!","shows no mercy!","is the shark of the table!","brought the heat!","just paid for gas with your money!"];
  const loseMsgs= ["donated to the pot üí∏","got bluffed into oblivion üòÖ","better luck next time!","is walking home broke!","claims it was 'all bad beats'‚Ä¶","put the 'cry' in cry-river"];
  const wm = winMsgs[Math.floor(Math.random()*winMsgs.length)];
  const lm = loseMsgs[Math.floor(Math.random()*loseMsgs.length)];
  alert(`üèÜ Winner: ${w.name} (+${fmt(w.net)})\nüëâ ${w.name} ${wm}\n\nüíÄ Loser: ${l.name} (${fmt(l.net)})\nüëâ ${l.name} ${lm}`);
});

/*** COLLAPSIBLE BANK ***/
(function bankCollapseInit(){
  const head = document.getElementById('bankHeader');
  const body = document.getElementById('bankBody');
  head.addEventListener('click', ()=>{
    const wasHidden = body.classList.contains('hidden');
    body.classList.toggle('hidden', !wasHidden ? true : false); // toggle
    head.classList.toggle('collapsed', body.classList.contains('hidden'));
  });
  body.classList.add('hidden');
  head.classList.add('collapsed');
})();

/*** EVENTS (app) ***/
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const { error } = await sb.from('players').select('id').limit(1);
    if (error) throw error;
    document.getElementById('debugPill').textContent = 'Debug ‚Ä¢ Connected';
  } catch (e) { document.getElementById('debugPill').textContent = 'Debug ‚Ä¢ Error'; dbgAppend('Connection error: '+ (e.message || e), true); }

  $('#addPlayerBtn').addEventListener('click', ()=> addPlayer($('#newPlayerName').value));
  $('#createGameBtn').addEventListener('click', async ()=>{
    const name = ($('#gameName').value || '').trim() || ('Poker Night ' + new Date().toLocaleString());
    const g = await createGameDB(name);
    currentGame = g;
    await renderPlayersSelection(true);
    $('#selectPlayersPane').classList.remove('hidden');
    await renderGame();
    await renderGamesDropdown();
    dbgAppend('Created game: '+name);
  });
  $('#joinGameBtn').addEventListener('click', async ()=>{
    const id = $('#existingGames').value; if(!id) return alert('Pick a game first.');
    currentGame = await getGameById(id);
    await renderGame();
    dbgAppend('Joined game '+id);
  });
  $('#selectPlayersBtn').addEventListener('click', async ()=>{
    await renderPlayersSelection(true);
    $('#selectPlayersPane').classList.remove('hidden');
  });
  $('#applyPlayersBtn').addEventListener('click', async ()=>{
    if(!currentGame) return;
    const checks = Array.from(document.querySelectorAll('#playersCheckboxes input[type=checkbox]'));
    const chosen = checks.filter(c=>c.checked).map(c=>c.value);
    const existing = await fetchGamePlayers(currentGame.id);
    const have = new Set(existing.map(r=>r.player_id));
    const toAdd = chosen.filter(id=>!have.has(id)).map(player_id=>({ game_id: currentGame.id, player_id }));
    const toRemove = existing.filter(r=>!chosen.includes(r.player_id)).map(r=>r.player_id);
    await insertGamePlayers(toAdd);
    await deleteGamePlayers(currentGame.id, toRemove);
    $('#selectPlayersPane').classList.add('hidden');
    await renderGame();
    dbgAppend('Applied player selection.');
  });
  $('#cancelPlayersBtn').addEventListener('click', ()=> $('#selectPlayersPane').classList.add('hidden'));
  $('#endGameBtn').addEventListener('click', endGame);
  $('#deleteGameBtn').addEventListener('click', async ()=>{
    if(!currentGame) return;
    await deleteGame(currentGame.id);
  });
  $('#newGameBtn').addEventListener('click', ()=>{
    currentGame = null;
    $('#gamePane').classList.add('hidden');
    $('#noGamePane').classList.remove('hidden');
    dbgAppend('Switched to New Game view.');
  });
  $('#refreshBtn').addEventListener('click', async ()=>{
    await Promise.all([renderPlayersBank(), renderGamesDropdown(), renderLifetime()]);
    if(currentGame) await renderGame();
    dbgAppend('Manual refresh.');
  });

  // Open/close modals
  $('#openWheel').addEventListener('click', ()=> openModal('wheelModal'));
  $('#openBall').addEventListener('click',  ()=> openModal('ballModal'));
  $('#closeWheel').addEventListener('click', ()=> closeModal('wheelModal'));
  $('#closeBall').addEventListener('click',  ()=> closeModal('ballModal'));
  document.getElementById('wheelModal').addEventListener('click', (e)=>{ if(e.target.id==='wheelModal') closeModal('wheelModal'); });
  document.getElementById('ballModal').addEventListener('click',  (e)=>{ if(e.target.id==='ballModal')  closeModal('ballModal'); });

  await Promise.all([renderPlayersBank(), renderGamesDropdown(), renderLifetime()]);
  await renderGame();
});

/*** REALTIME (optional) ***/
try{
  sb.channel('realtime:players')
   .on('postgres_changes', { event:'*', schema:'public', table:'players' }, async ()=>{
     await renderPlayersBank(); await renderPlayersSelection(); await renderLifetime();
     dbgAppend('Realtime: players changed.');
   }).subscribe();

  sb.channel('realtime:games')
   .on('postgres_changes', { event:'*', schema:'public', table:'games' }, async ()=>{
     await renderGamesDropdown();
     dbgAppend('Realtime: games changed.');
   }).subscribe();

  ['game_players','buyins','cashouts'].forEach(t=>{
    sb.channel('realtime:'+t)
      .on('postgres_changes', { event:'*', schema:'public', table:t }, async ()=>{
        if(currentGame) await renderGame();
        await renderLifetime();
        dbgAppend('Realtime: '+t+' changed.');
      }).subscribe();
  });
}catch(e){ dbgAppend('Realtime setup error: '+(e.message||e), true); }

/* ======================= MODAL HELPERS ======================= */
function openModal(id){ const m=document.getElementById(id); m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
function closeModal(id){ const m=document.getElementById(id); m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }

/* ======================= FUN WHEEL LOGIC ======================= */
(() => {
  const canvas = document.getElementById('wheelCanvas');
  const ctx = canvas.getContext('2d');
  const cx = canvas.width/2, cy = canvas.height/2, R = Math.min(canvas.width, canvas.height)/2 - 20;
  const PEG_COUNT=60, SPIN_MS=8000, EXTRA_TURNS=5;

  // Weighted slices (Pre-Flop tiniest; All-In small; Bluff small; others large)
  const SEGMENTS = [
    {label:"Pre-Flop Raise", weight:0.3, color:"#facc15"},
    {label:"All-In",         weight:0.5, color:"#ef4444"},
    {label:"Bluff",          weight:1.0, color:"#f97316"},
    {label:"Call",           weight:2.0, color:"#22c55e"},
    {label:"Raise",          weight:2.0, color:"#3b82f6"},
    {label:"Fold",           weight:2.0, color:"#a855f7"},
  ];
  const totalWeight = SEGMENTS.reduce((s,x)=>s+x.weight,0);

  let angle=0, spinning=false, stopRequested=false, startAngle=0, targetAngle=0, startTime=0, lastTickIndex=null;

  const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  function clickSound(){
    try{
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type="square"; o.frequency.value=1200; g.gain.value=0.02;
      o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.03);
    }catch(e){}
  }
  const norm = a => { a%=2*Math.PI; if(a<0) a+=2*Math.PI; return a; };
  const EASE = t => 1 - Math.pow(1 - t, 5); // easeOutQuint

  function draw(a){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(a);
    let start=0;
    for(const seg of SEGMENTS){
      const arc=2*Math.PI*(seg.weight/totalWeight);
      ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,start,start+arc); ctx.closePath();
      ctx.fillStyle=seg.color; ctx.fill();

      // label
      ctx.save();
      const mid=start+arc/2;
      ctx.rotate(mid); ctx.translate(R*0.62,0); ctx.rotate(Math.PI/2);
      if(seg.label==="Pre-Flop Raise"){
        // vertical stacked words with autosize
        const words=["Pre","Flop","Raise"];
        const arcLen = arc*(R*0.62); let fontPx=16; if(arcLen<60) fontPx=12;
        ctx.font=`bold ${fontPx}px sans-serif`;
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.strokeStyle="rgba(0,0,0,.3)"; ctx.lineWidth=3;
        const lh=Math.round(fontPx*1.05), totalH=words.length*lh; let y=-totalH/2+lh/2;
        words.forEach(w=>{ ctx.strokeText(w,0,y); y+=lh; });
        y=-totalH/2+lh/2; ctx.fillStyle="#f8fafc"; words.forEach(w=>{ ctx.fillText(w,0,y); y+=lh; });
      }else{
        const arcLen = arc*(R*0.62); let fontPx=18; if(arcLen<90) fontPx=16; if(arcLen<70) fontPx=14;
        ctx.font=`bold ${fontPx}px sans-serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.strokeStyle="rgba(0,0,0,.3)"; ctx.lineWidth=3; ctx.strokeText(seg.label,0,0);
        ctx.fillStyle="#f8fafc"; ctx.fillText(seg.label,0,0);
      }
      ctx.restore();
      start+=arc;
    }
    // pegs
    ctx.fillStyle="#dbeafe";
    for(let i=0;i<PEG_COUNT;i++){
      const pa=i*(2*Math.PI/PEG_COUNT);
      ctx.beginPath(); ctx.arc(Math.cos(pa)*(R+4),Math.sin(pa)*(R+4),2,0,2*Math.PI); ctx.fill();
    }
    ctx.restore();
  }

  function segmentUnderPointer(a){
    const pointerRel = norm(-Math.PI/2 - a); // top pointer
    let acc=0;
    for(const seg of SEGMENTS){
      const arc=2*Math.PI*(seg.weight/totalWeight);
      if(pointerRel>=acc && pointerRel<acc+arc) return seg;
      acc+=arc;
    }
    return SEGMENTS[SEGMENTS.length-1];
  }

  function spin(){
    if(spinning) return;
    spinning=true; stopRequested=false; startTime=performance.now(); startAngle=angle;

    // weighted pick
    const r=Math.random()*totalWeight; let acc=0, chosen=null, idx=0;
    for(let i=0;i<SEGMENTS.length;i++){ acc+=SEGMENTS[i].weight; if(r<=acc){ chosen=SEGMENTS[i]; idx=i; break; } }
    let offW=0; for(let i=0;i<idx;i++) offW+=SEGMENTS[i].weight;
    const chosenCenter=(offW + chosen.weight/2)/totalWeight*2*Math.PI;
    const landAt = norm(-Math.PI/2 - chosenCenter);
    const totalRot = EXTRA_TURNS*2*Math.PI + landAt - norm(startAngle);
    targetAngle = startAngle + totalRot;

    lastTickIndex=null;
    document.getElementById('wheelResult').textContent = "Spinning‚Ä¶";
    animate();
  }
  function stopSpin(){ stopRequested=true; }
  function animate(){
    if(!spinning) return;
    requestAnimationFrame(animate);
    const elapsed=performance.now()-startTime;
    const dur=stopRequested?Math.min(SPIN_MS,1200):SPIN_MS;
    const p=Math.min(1,elapsed/dur), eased=EASE(p);
    angle = startAngle + (targetAngle - startAngle)*eased;

    const pegAngle=2*Math.PI/PEG_COUNT, pegIndex=Math.floor(angle/pegAngle);
    if(lastTickIndex===null) lastTickIndex=pegIndex;
    if(pegIndex!==lastTickIndex){ clickSound(); lastTickIndex=pegIndex; }

    draw(angle);
    if(p>=1){
      spinning=false;
      angle=targetAngle; draw(angle);
      const seg = segmentUnderPointer(angle);
      document.getElementById('wheelResult').textContent = `Result: ${seg.label}`;
    }
  }

  draw(angle);
  document.getElementById('spinBtn').onclick=spin;
  document.getElementById('stopBtn').onclick=stopSpin;
})();

/* ======================= MAGIC 8-BALL LOGIC ======================= */
(() => {
  const RESPONSES = [
    "Yes ‚Äî total bluff","Probably bluffing","Bluff written all over it","Pay to find out","99% bluff",
    "Her story leaks chips","Everything screams bluff","Cards look like air","Thin value‚Ä¶ still bluffy","she has 2 pair"
  ];
  // Bias toward bluff by duplicating some ‚Äúyes‚Äù lines
  const WEIGHTED = [
    "Yes ‚Äî total bluff","Yes ‚Äî total bluff",
    "Probably bluffing","Probably bluffing",
    "Bluff written all over it","Bluff written all over it",
    "Pay to find out",
    "99% bluff",
    "Her story leaks chips",
    "Everything screams bluff",
    "Cards look like air",
    "Thin value‚Ä¶ still bluffy",
    "she has 2 pair"
  ];

  const ball = document.getElementById('ball');
  const ans  = document.getElementById('answer');
  const shakeBtn = document.getElementById('shakeBtn');
  const againBtn = document.getElementById('againBtn');
  ans.textContent = "‚Äî";

  function pick(){ return WEIGHTED[Math.floor(Math.random()*WEIGHTED.length)]; }

  // Subtle ‚Äúthunk + rattle‚Äù sound
  let audioCtx;
  function playShakeSound(){
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      // Low thunk
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(120, audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(65, audioCtx.currentTime + 0.16);
      g.gain.value = 0.17;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.17);

      // Tiny rattles
      for(let k=0;k<4;k++){
        const t0 = audioCtx.currentTime + 0.12 + k*0.1;
        const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*0.05, audioCtx.sampleRate);
        const data = buf.getChannelData(0);
        for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * (1 - i/data.length);
        const src = audioCtx.createBufferSource(); src.buffer = buf;
        const gn = audioCtx.createGain(); gn.gain.value = 0.06;
        src.connect(gn); gn.connect(audioCtx.destination);
        src.start(t0); src.stop(t0 + 0.05);
      }
    }catch(e){}
  }

  let shaking = false;
  function shake(){
    if(shaking) return;
    shaking = true;
    ans.textContent = "‚Äî";
    ans.classList.remove('reveal');

    ball.classList.remove('shake'); // restart animation
    // force reflow
    // eslint-disable-next-line no-unused-expressions
    ball.offsetHeight;
    ball.classList.add('shake');

    playShakeSound();

    // reveal answer a bit after shake starts
    setTimeout(()=>{
      ans.textContent = pick();
      ans.classList.add('reveal');
      setTimeout(()=> shaking=false, 900);
    }, 1700);
  }
  function askAgain(){
    if(shaking) return;
    ans.classList.remove('reveal');
    setTimeout(()=>{
      ans.textContent = pick();
      ans.classList.add('reveal');
    }, 60);
  }

  ball.addEventListener('click', shake);
  shakeBtn.addEventListener('click', shake);
  againBtn.addEventListener('click', askAgain);
})();
</script>
</body>
</html>
